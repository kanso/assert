<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
  <head> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
    <title>KansoJS</title> 
    <link  href="//fonts.googleapis.com/css?family=Ubuntu:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css" >
    <link rel="stylesheet" href="http://yandex.st/highlightjs/5.16/styles/github.min.css">
    <style>
      body {
        line-height: 1.618em;
        font-size: 12px;
        margin: 4.236em;
        font-family: 'Lucida Grande', 'Lucida Sans Unicode', verdana, geneva, sans-serif;
        color: #292626;
        width: 56em;
      }
      h1 {
        line-height: 1em;
        font-family: 'Ubuntu', serif;
        font-size: 4.236em;
        font-weight: normal;
        letter-spacing: -0.055em;
        color: black;
      }
      h1 span {
        font-size: 0.618em;
        background: red;
        color: white;
        padding: 0.146em 0.236em;
        position: relative;
        top: -0.1em;
        margin-left: 0.146em;
      }
      p {
        margin: 2.618em 0;
        padding: 0;
      }
      a {
        text-decoration: none;
        background-color: #D6CDA0;
        padding: 0.263em;
        color: black;
      }
      a:hover {
        background-color: #96896F;
        color: white;
      }
      ul {
        line-height: 2.618em;
      }
      h2, h3 {
        margin: 2.618em 0 1.618em 0;
      }
      h2 {
        font-size: 1.618em;
        font-weight: bold;
      }
      h3 {
        font-size: 1em;
        font-weight: bold;
      }
      pre {
        border: dashed 1px #D6CDA0;
        border-left: 0.382em solid #D6CDA0;
        padding: 1em 2.618em;
        margin: 0;
      }
      code {
        background-color: white !important;
      }
    </style>
  </head> 
  <body> 
    <h1>Kanso<span>JS</span></h1>

    <p>The deceptively simple way to write <a href="http://couchapp.org">CouchApps</a>.</p>

    <ul class="features">
      <li><strong>Flexible</strong> - a lightweight CommonJS environment</li>
      <li><strong>Reduces code fragmentation</strong> - by bringing the client-side and server-side together</li>
      <li><strong>Automatic history support</strong> - adds pushState and hash-based URLs automatically</li>
      <li><strong>Searchable and degradable</strong> - add Google-indexable pages and support clients without JavaScript</li>
      <li><strong>Familiar</strong> - all this can be done by using the CouchDB design doc APIs</li>
    </ul>

    <p>
      CouchApps are JavaScript and HTML based apps served directly
      from CouchDB. This means a super-simple stack and portable apps that can be
      shared and deployed using CouchDB's builtin replication.
      If you're not familiar with CouchApps, I highly recommend reading
      <a href="http://couchapp.org/page/what-is-couchapp">What in the HTTP is a CouchApp?</a>.
    </p>

    <h2>The idea</h2>

    <h3>Browser and server together</h3>
    <p>
      The simple idea behind KansoJS is to add support for the design doc
      API to the client-side. CouchDB already allows you to respond to requests
      dynamically using list and show functions. Now, you can add client-side code
      too, so you can make additional requests and perform more complex
      operations in the browser.  CouchDB itself can then run the basic
      parts of these functions as a fall-back for search-engines or browsers
      without JavaScript enabled.
    </p>
    <pre><code class="javascript">function example_show(doc, req, client) {
    if (client) {
        // being run client-side, update the current page
        $('#main').html(result);
    }
    else {
        // fallback, returns a complete rendered page
        return kanso.template('base', {main: result});
    }
};</code></pre>
    <p>
      This means the redirects you define for list and show functions also
      fire in the browser, allowing for automatic URL handling using pushState or
      location.hash. It also means you get the relevant view or document for a URL
      automatically fetched for your client-side code, leaving you to worry about
      what to do with it!
    <p>

    <h3>CommonJS</h3>
    <p>
      Writing your JavaScript in
      <a href="http://wiki.commonjs.org/wiki/Modules">CommonJS modules</a> is much
      nicer than loading separate files which all modify the global scope. You may
      already know that you can now use CommonJS modules in your CouchDB list,
      show, validation and other functions. This makes it an ideal style to use
      throughout your application.
    </p>
    <pre><code class="javascript">var kanso = require('kanso');

exports.rewrites = [
    {from: '/:id', to: '_shows/example/:id'}
];

exports.shows = {
    example: function (doc, req, client) {
        ...
    }
};</code></pre>
    <p>
      One problem with CouchApps is the reliance on structuring your data on the
      filesystem as you would like it to appear in the design doc. This means a
      complex hierarchy of folders and files to represent properties in a JSON
      document. It would be much better if you could represent this information in
      whichever way suits the project. By loading the design doc data from a
      module, its up to you how to structure it on the filesystem.
    </p>
    <p>
      Instead of relying on CouchApp macros to include code from other files (by
      using special comments in your code), you can do it more cleanly using
      the CommonJS 'require' function.
    </p>

    <h2>Getting started</h2>

    <h3>Installation</h3>
    <p>
      Install the most recent <em>stable</em> version of
      <a href="http://nodejs.org/#download">node</a>, then clone
      <a href="https://github.com/caolan/kanso">KansoJS</a> from GitHub.
      Fetch the relevant submodules by doing this in the cloned directory:
    </p>
    <pre>git submodule init
git submodule update</pre>
    <p>You are then ready to install:</p>
    <pre>make &amp;&amp; sudo make install</pre>

    <h3>Starting a project</h3>
    <p>
      For this tutorial we'll be creating a basic app that displays books by
      author. First, change to the location you wish to create the project directory
      in, then start a new project by doing:
    </p>
    <pre>kanso create bookstore</pre>
    <p>
      This will create a new directory called 'bookstore' containing a project
      skeleton to get you started. The contents of this directory should look
      something like the following:
    </p>
    <pre>bookstore
  |- lib                        commonjs modules relevant to the app
  |- static                     static files to be attached to design doc
  |- templates                  templates used by the app
     |- base.html
     |- welcome.html
  |- app.js                     the module loaded as a design doc
  |- kanso.json                 kanso settings
    </pre>
    <p>
      Before exploring these files in more detail, lets push the app to a couchdb
      database and check that everything works. For this tutorial, I'll assume you
      have a local couchdb database running at localhost:5984 (the default settings).
    </p>
    <pre>kanso push http://localhost:5984/bookstore</pre>
    <p>
      If you now visit
      <a href="http://localhost:5984/bookstore/_design/bookstore/_rewrite/">http://localhost:5984/bookstore/_design/bookstore/_rewrite/</a>
      you should see a basic welcome page. Don't worry about the long and ugly URL
      for now, this can be fixed later using
      <a href="http://wiki.apache.org/couchdb/Virtual_Hosts">virtual hosts</a>.
    </p>

    <h3>kanso.json</h3>
    <p>
      Let's take a look at the kanso.json file first. This file contains the
      settings for the app, and tells kanso which files and directories to load
      and how to load them.
    </p>
    <pre><code class="javascript">{
    "name": "bookstore",          // the name of the app
    "load": "app",                // the module to get design doc properties from
    "modules": ["lib","app.js"],  // files and directories to load as commonjs modules
    "templates": "templates",     // templates directory
    "attachments": "static"       // files and directories to load as attachments
}</code></pre>
    <p>
      The name determines the id of the design doc, in this case it would be
      _design/bookstore. You may also notice that the modules and attachments
      properties accept either a single string or an array of strings as their
      values. Currently, only one templates folder is supported, although its
      possible to use subdirectories below that.
    </p>
    <p>
      Perhaps the most important part is the 'load' property. This tells kanso
      which module to require and use for the design doc. This means any exported
      values in this module will be used in the resulting design doc.
    </p>

    <h3>app.js</h3>
    <p>
      This file contains some exported properties which are used in the resulting
      design doc, this is where the action happens and you get to define the
      behaviour of your app:
    </p>
    <pre><code class="javascript">var kanso = require('kanso');


exports.rewrites = [
    {from: '/', to: '_show/welcome'}
];

exports.shows = {
    welcome: function (doc, req, client) {
        return kanso.template('welcome.html');
    }
};</code></pre>
    <p>
      You'll notice the the skeleton project we generated comes with a rewrite
      already setup. This rewrites the root url to a show function called 'welcome'.
      The welcome function then shows the welcome template (the page you've already
      seen after pushing the app).
    </p>
    <p>
      There are a couple of interesting things here. Firstly, we've required a
      'kanso' module which doesn't exist in our project directory. This is a special
      module which is always present in your apps, and added automatically by kanso
      itself.
    </p>
    <p>
      Secondly, we're actually using the context of the module inside the
      welcome function. With a normal CouchApp these functions are just converted
      to strings and inserted into the design doc, but kanso will try to proxy the
      function using a require call (remember I said CouchDB supports CommonJS?).
      This means we have access to the normal scope of the surrounding code,
      allowing us to use the kanso module we required at the top of the module
      inside the welcome function.
    </p>
    <p>
      <strong>Note:</strong> The one important exception to this is view functions,
      CouchDB views do not support CommonJS modules in the same way and must be
      self contained.
    </p>

    <script src="http://yandex.st/highlightjs/5.16/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>
