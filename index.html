<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
  <head> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
    <title>KansoJS</title> 
    <link  href="//fonts.googleapis.com/css?family=Ubuntu:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css" >
    <link rel="stylesheet" href="http://yandex.st/highlightjs/5.16/styles/github.min.css">
    <style>
      body {
        line-height: 1.618em;
        font-size: 12px;
        margin: 4.236em;
        font-family: 'Lucida Grande', 'Lucida Sans Unicode', verdana, geneva, sans-serif;
        color: #292626;
        width: 56em;
      }
      h1 {
        line-height: 1em;
        font-family: 'Ubuntu', serif;
        font-size: 4.236em;
        font-weight: normal;
        letter-spacing: -0.055em;
        color: black;
      }
      h1 span {
        font-size: 0.618em;
        background: red;
        color: white;
        padding: 0.146em 0.236em;
        position: relative;
        top: -0.1em;
        margin-left: 0.146em;
      }
      p {
        margin: 2.618em 0;
        padding: 0;
      }
      a {
        text-decoration: none;
        background-color: #D6CDA0;
        padding: 0.263em;
        color: black;
      }
      a:hover {
        background-color: #96896F;
        color: white;
      }
      ul {
        line-height: 2.618em;
      }
      h2, h3 {
        margin: 2.618em 0 1.618em 0;
      }
      h2 {
        font-size: 1.618em;
        font-weight: bold;
      }
      h3 {
        font-size: 1em;
        font-weight: bold;
      }
      pre {
        border: dashed 1px #D6CDA0;
        border-left: 0.382em solid #D6CDA0;
        padding: 1em 2.618em;
        margin: 0;
      }
      code {
        background-color: white !important;
      }
    </style>
  </head> 
  <body> 
    <h1>Kanso<span>JS</span></h1>

    <p>The surprisingly simple way to write <a href="http://couchapp.org">CouchApps</a>.</p>

    <ul class="features">
      <li><strong>Flexible</strong> - a lightweight CommonJS environment</li>
      <li><strong>Reduces code fragmentation</strong> - by bringing the client-side and server-side together</li>
      <li><strong>Automatic history support</strong> - adds pushState and hash-based URLs automatically</li>
      <li><strong>Searchable and degradable</strong> - add Google-indexable pages and support clients without JavaScript</li>
      <li><strong>Familiar</strong> - all this can be done by using the CouchDB design doc APIs</li>
    </ul>

    <p>
      CouchApps are JavaScript and HTML based apps served directly
      from CouchDB. This means a super-simple stack and portable apps that can be
      shared and deployed using CouchDB's built-in replication.
      If you're not familiar with CouchApps, I highly recommend reading
      <a href="http://couchapp.org/page/what-is-couchapp">What in the HTTP is a CouchApp?</a>.
    </p>

    <h2>The idea</h2>

    <h3>Browser and server together</h3>
    <p>
      I hate writing everything twice in order to have fast and dynamic
      sites which also provide fallbacks. Its annoying to copy around URL
      maps so that JavaScript can manipulate browser history sensibly.
      Its really annoying to have to implement validation twice, usually
      in two different languages.
    </p>
    <p>
      The simple idea behind Kanso is to support the design doc API in the
      browser.
    </p>
    <p>
      CouchDB already allows dynamic responses using list and show functions.
      Now, you can add client-side code too. That means you're able to fetch
      additional documents or perform other complex operations from the
      browser. CouchDB itself can then run the basic parts as a fall-back for
      search engines or browsers without JavaScript. The rewrites you define
      will fire in the browser too, allowing for automatic URL handling using
      pushState or location.hash.
    </p>
    <pre><code class="javascript">function example_show(doc, req) {
    if (req.client) {
        // being run client-side, update the current page
        $('#main').html(result);
    }
    else {
        // fallback, returns a complete rendered page
        return kanso.template(req, 'base.html', {main: result});
    }
};</code></pre>
    <p><strong>STOP</strong>... and just think about that for a moment.</p>
    <p>
      Think about all the things I'm <strong>not</strong> having to write.
      I'm not having to set up Sammy.js on the client side with URL rewrite
      rules that match CouchDB. I'm not having to fetch the document
      for that URL before I'm able to template the page. I'm
      also not having to maintain two completely different sets of code,
      one for the browser and another for CouchDB.
    </p>

    <h3>CommonJS</h3>
    <p>
      Writing your JavaScript in
      <a href="http://wiki.commonjs.org/wiki/Modules">CommonJS modules</a> is
      much nicer than loading separate files which all modify the global
      scope. You may already know that you can use CommonJS modules in
      your CouchDB list, show, validation and other functions. This makes it
      an ideal style to use throughout your application.
    </p>
    <pre><code class="javascript">var kanso = require('kanso');

exports.rewrites = [
    {from: '/:id', to: '_shows/example/:id'}
];

exports.shows = {
    example: function (doc, req) {
        ...
    }
};</code></pre>
    <p>
      One problem with CouchApps is the reliance on structuring your data on the
      filesystem as you would like it to appear in the design doc. This means a
      complex hierarchy of folders and files to represent properties in a JSON
      document. It would be much better if you could represent this information in
      whichever way suits the project. By loading the design doc data from a
      module, its up to you how to structure it on the filesystem.
    </p>
    <p>
      Instead of relying on CouchApp macros to include code from other files (by
      using special comments in your code), you can do it more cleanly using
      the CommonJS 'require' function.
    </p>

    <h2>Getting started</h2>

    <h3>Installation</h3>
    <p>
      Install the most recent <em>stable</em> version of
      <a href="http://nodejs.org/#download">node</a>, then clone
      <a href="https://github.com/caolan/kanso">Kanso</a> from GitHub.
      Fetch the relevant submodules by doing this in the cloned directory:
    </p>
    <pre>git submodule init
git submodule update</pre>
    <p>You are then ready to install:</p>
    <pre>make &amp;&amp; sudo make install</pre>

    <h3>Starting a project</h3>
    <p>
      For this tutorial we'll be creating a basic app that displays books by
      author. First, change to the location you wish to create the project directory
      in, then start a new project by doing:
    </p>
    <pre>kanso create bookstore</pre>
    <p>
      This will create a new directory called 'bookstore' containing a project
      skeleton to get you started. The contents of this directory should look
      something like the following:
    </p>
    <pre>bookstore
  |- lib                        commonjs modules relevant to the app
  |- static                     static files to be attached to design doc
  |- templates                  templates used by the app
     |- base.html
     |- welcome.html
  |- app.js                     the module loaded as a design doc
  |- kanso.json                 kanso settings
    </pre>
    <p>
      Before exploring these files in more detail, lets push the app to a couchdb
      database and check that everything works. For this tutorial, I'll assume you
      have a local couchdb database running at localhost:5984 (the default settings).
      In your project directory, do the following:
    </p>
    <pre>kanso push http://localhost:5984/bookstore</pre>
    <p>
      If you now visit
      <a href="http://localhost:5984/bookstore/_design/bookstore/_rewrite/">http://localhost:5984/bookstore/_design/bookstore/_rewrite/</a>
      you should see a basic welcome page. Don't worry about the long and ugly URL
      for now, this can be fixed later using
      <a href="http://wiki.apache.org/couchdb/Virtual_Hosts">virtual hosts</a>.
    </p>

    <h3>kanso.json</h3>
    <p>
      Let's take a look at the kanso.json file first. This file contains the
      settings for the app, and tells kanso which files and directories to load
      and how to load them.
    </p>
    <pre><code class="javascript">{
    "name": "bookstore",          // the name of the app
    "load": "app",                // the module to get design doc properties from
    "modules": ["lib","app.js"],  // files and directories to load as commonjs modules
    "templates": "templates",     // templates directory
    "attachments": "static"       // files and directories to load as attachments
}</code></pre>
    <p>
      The name determines the id of the design doc, in this case it would be
      "_design/bookstore". You may also notice that the modules and attachments
      properties accept either a string or an array of strings as their
      values. Currently, only one templates folder is supported, although its
      possible to use subdirectories below that.
    </p>
    <p>
      Perhaps the most important part is the 'load' property. This tells kanso
      which module to require and use for the design doc. This means any
      exported values in this module will be used in the resulting design doc.
    </p>

    <h3>app.js</h3>
    <p>
      This file contains some exported properties which are used in the resulting
      design doc, this is where the action happens and you get to define the
      behaviour of your app:
    </p>
    <pre><code class="javascript">var kanso = require('kanso');


exports.rewrites = [
    {from: '/static/*', to: 'static/jquery-1.4.2.min.js'},
    {from: '/', to: '_show/welcome'}
];

exports.shows = {
    welcome: function (doc, req) {
        var content = kanso.template(req, 'welcome.html', {});

        if (req.client) {
            $('#content').html(content);
            document.title = 'It worked!';
        }
        else {
            return kanso.template(req, 'base.html', {
                title: 'It worked!',
                content: content
            });
        }
    }
};</code></pre>
    <p>
      You'll notice the skeleton project we generated comes with some rewrites
      already set up. The first exposes the static directory, the second
      rewrites the root url to a show function called 'welcome'. The welcome
      function then shows the welcome template (the page you've already
      seen after pushing the app). If this function is run client-side,
      it replaces the contents of the current page with the welcome message,
      otherwise it returns a new page.
    </p>
    <p>
      There are a couple of interesting things here. Firstly, we've required a
      'kanso' module which doesn't exist in our project directory. This is a
      special module which is always present in your apps, and added
      automatically by kanso itself. The kanso module provides access to core
      components such as templating.
    </p>
    <p>
      Secondly, we're actually using the context of the module inside the
      welcome function. With a normal CouchApp these functions are just
      converted to strings and inserted into the design doc, but kanso will
      try to proxy the function using a require call (remember I said CouchDB
      supports CommonJS?). This means we have access to the normal scope of
      the surrounding code, allowing us to use the kanso module we required at
      the top of the module inside the welcome function.
    </p>
    <p>
      <strong>Note:</strong> The one important exception to this is view
      functions, CouchDB views do not support CommonJS modules in the same way
      and must be self contained.
    </p>

    <h3>templates/base.html</h3>
    <p>
      Kanso uses <a href="http://akdubya.github.com/dustjs/#about">Dust</a>
      templates. These templates look similar to
      <a href="http://mustache.github.com">Mustache</a>, but provide some
      powerful additions such as filters, path lookups, blocks and better 
      partials support. Dust templates can also be pre-compiled, meaning your
      templates are compiled when you 'kanso push', not each time a page is
      rendered.
    </p>
    <pre><code class="html">&lt;html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"&gt; 
  &lt;head&gt; 
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt; 
    &lt;title&gt;{title}&lt;/title&gt; 
  &lt;/head&gt; 
  &lt;body&gt; 
    {content|s}
    &lt;script src="{baseURL}/static/jquery-1.4.2.min.js"&gt;&lt;/script&gt;
    &lt;script src="{baseURL}/kanso.js"&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
    <p>
      <a href="http://akdubya.github.com/dustjs">Learn more about the dust syntax</a>
    </p>
    <p>
      This template should be fairly self-explanatory. We describe a basic
      html document and render some variables: 'title', 'content' and
      'baseURL'.
    </p>
    <p>
      The 'content' variable passes through a filter 's'. This just means the
      value isn't escaped (we're going to be putting html in there!).
    </p>
    <p>
        The variable 'baseURL' also deserves a mention. This is automatically
        made available in templates, and changes depending on whether the
        request uses a virtual host or not. If you've used CouchApps with
        virtual hosts before, you may be familiar with the problem of
        including stylesheets and javascript without knowing the current
        full path. Using baseURL fixes that, meaning you can run your CouchApp
        either behind a virtual host or access it directly in the
        /db/_design/doc/_rewrite/ style.
    </p>

    <h3>templates/welcome.html</h3>
    <pre><code class="no-highlight">&lt;h1&gt;It worked!&lt;/h1&gt;
&lt;p&gt;Welcome to your new Kanso-powered app.&lt;p&gt;</code></pre>

    <p>
        Not much to see here, just some HTML we put into the 'content'
        section of the base.html template.
    </p>

    <h2>The Bookstore</h2>
    <p>
      OK, now we've explored a skeleton Kanso project, let's start building our
      own web app on top of it. Open Futon and view the bookstore database at
      <a href="http://localhost:5984/_utils/database.html?bookstore">http://localhost:5984/_utils/database.html?bookstore</a>.
      You should have already created this when we pushed the new project to
      localhost in the 'Getting started' section above.
    </p>
    <p>Add the following documents:</p>
    <pre><code type="javascript">{
  "type": "book",
  "authors": ["J. Chris Anderson","Jan Lehnardt","Noah Slater"],
  "title": "CouchDB: The Definitive Guide"
}

{
  "type": "book",
  "authors": ["D Crockford"],
  "title": "JavaScript: The Good Parts"
}

{
  "type": "book",
  "authors": ["Joe Armstrong"],
  "title": "Programming Erlang: Software for a Concurrent World"
}</code></pre>

    <h3>Creating views</h3>
    <p>
      Now we have some data to play with, lets create a view to list books
      by author. For this, we'll need to edit the app.js file to include the
      following:
    <p>
<pre><code type="javascript">exports.views = {
    books_by_author: {
        map: function (doc) {
            if (doc.type === 'book') {
                for (var i = 0; i &lt; doc.authors.length; i++) {
                    emit(doc.authors[i], {title: doc.title});
                }
            }
        }
    }
};</code></pre>
    <p>
      This can be split into separate files at any point and included using
      require(), but for now we're going to keep everything in app.js.
    </p>
    <p>Let's push the app again to update it:</p>
    <pre>kanso push http://localhost:5984/bookstore</pre>
    <p>
      You can now see the results at
      <a href="http://localhost:5984/bookstore/_design/bookstore/_view/books_by_author">http://localhost:5984/bookstore/_design/bookstore/_view/books_by_author</a>.
    </p>

    <h3>Adding lists and rewrites</h3>
    <p>
      Now we have a working view, lets setup a list function to replace the
      default welcome page. Add the following to app.js:
    </p>
    <pre><code class="javascript">exports.lists = {
    authors: function (head, req) {
        start({"headers": {"Content-Type": "text/html"} });

        var row, rows = [];
        while (row = getRow()) {
            rows.push(row);
        }
        var content = kanso.template(req, 'authors.html', {
            rows: rows
        });

        if (req.client) {
            $('#content').html(content);
            document.title = 'Authors';
        }
        else {
            return kanso.template(req, 'base.html', {
                title: 'Authors',
                content: content
            });
        }
    }
};</code></pre>
    <p>
      Now, update the rewrite rules so the root URL points to the new list
      function instead of the welcome page:
    </p>
    <pre><code class="javascript">exports.rewrites = [
    {from: '/', to: '_list/authors/books_by_author'}
];</code></pre>
    <p>Next, lets add the 'authors.html' template to the templates folder:</p>
    <pre><code class="html">&lt;ul&gt;
    {#rows}
        &lt;li&gt;{key}&lt;/li&gt;
    {/rows}
&lt;/ul&gt;</code></pre>
    <p>
      Push the app again, then open 
      <a href="http://localhost:5984/bookstore/_design/bookstore/_rewrite/">http://localhost:5984/bookstore/_design/bookstore/_rewrite/</a>.
    </p>

    <!-- GitHub ribbon -->
    <a href="http://github.com/caolan/kanso"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://assets2.github.com/img/7afbc8b248c68eb468279e8c17986ad46549fb71?repo=&url=http%3A%2F%2Fs3.amazonaws.com%2Fgithub%2Fribbons%2Fforkme_right_darkblue_121621.png&path=" alt="Fork me on GitHub"></a>

    <script src="http://yandex.st/highlightjs/5.16/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-20477836-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </body>
</html>
